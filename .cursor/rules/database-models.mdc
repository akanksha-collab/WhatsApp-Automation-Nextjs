---
alwaysApply: true
---

# Database Models

### Entity Model (Legal Case Collection)
```typescript
// lib/db/models/Entity.ts
import mongoose, { Schema, Document, Model } from 'mongoose';

export interface IMedia {
  url: string;
  publicId: string;         // Cloudinary/S3 ID
  type: 'image' | 'video';
  caption?: string;
  usageCount: number;       // Track how many times used
  lastUsedAt?: Date;
}

export interface IEntity {
  userId: string;
  companyName: string;
  tickerSymbol: string;
  leadPlaintiffDate: Date;
  caseDate: Date;
  description?: string;
  
  // Media collections
  images: IMedia[];
  videos: IMedia[];
  
  // External links
  youtubeLink?: string;
  podcastLink?: string;
  articleLinks: string[];
  
  // Scheduling preferences
  isActive: boolean;
  priority: number;          // Auto-calculated based on lead plaintiff date
  lastPostedAt?: Date;
  totalPostCount: number;
  
  // Status
  status: 'active' | 'completed' | 'paused';
  
  createdAt: Date;
  updatedAt: Date;
}

export interface IEntityDocument extends IEntity, Document {}

const MediaSchema = new Schema({
  url: { type: String, required: true },
  publicId: { type: String, required: true },
  type: { type: String, enum: ['image', 'video'], required: true },
  caption: { type: String },
  usageCount: { type: Number, default: 0 },
  lastUsedAt: { type: Date },
});

const EntitySchema = new Schema<IEntityDocument>(
  {
    userId: { type: String, required: true, index: true },
    companyName: { type: String, required: true },
    tickerSymbol: { type: String, required: true, uppercase: true },
    leadPlaintiffDate: { type: Date, required: true, index: true },
    caseDate: { type: Date, required: true },
    description: { type: String },
    
    images: [MediaSchema],
    videos: [MediaSchema],
    
    youtubeLink: { type: String },
    podcastLink: { type: String },
    articleLinks: [{ type: String }],
    
    isActive: { type: Boolean, default: true },
    priority: { type: Number, default: 0 },
    lastPostedAt: { type: Date },
    totalPostCount: { type: Number, default: 0 },
    
    status: { 
      type: String, 
      enum: ['active', 'completed', 'paused'],
      default: 'active'
    },
  },
  { timestamps: true }
);

// Compound indexes for efficient queries
EntitySchema.index({ userId: 1, status: 1 });
EntitySchema.index({ userId: 1, leadPlaintiffDate: 1 });
EntitySchema.index({ userId: 1, priority: -1 });

export const Entity: Model<IEntityDocument> =
  mongoose.models.Entity || mongoose.model<IEntityDocument>('Entity', EntitySchema);
```

### Scheduled Post Model
```typescript
// lib/db/models/ScheduledPost.ts
import mongoose, { Schema, Document, Model } from 'mongoose';

export type ContentType = 'image' | 'video' | 'text' | 'youtube' | 'podcast' | 'article';
export type PostStatus = 'scheduled' | 'processing' | 'sent' | 'failed' | 'cancelled';

export interface IScheduledPost {
  userId: string;
  entityId: string;
  
  // Content details
  contentType: ContentType;
  mediaUrl?: string;
  mediaPublicId?: string;
  message: string;
  link?: string;
  
  // Scheduling
  scheduledAt: Date;
  scheduledDay: string;        // 'monday', 'tuesday', etc.
  timeSlotId: string;          // Reference to time slot
  
  // Status tracking
  status: PostStatus;
  sentAt?: Date;
  errorMessage?: string;
  maytapiMessageId?: string;
  
  // Metadata
  priority: number;
  isAutoGenerated: boolean;
  
  createdAt: Date;
  updatedAt: Date;
}

export interface IScheduledPostDocument extends IScheduledPost, Document {}

const ScheduledPostSchema = new Schema<IScheduledPostDocument>(
  {
    userId: { type: String, required: true, index: true },
    entityId: { type: String, required: true, index: true },
    
    contentType: { 
      type: String, 
      enum: ['image', 'video', 'text', 'youtube', 'podcast', 'article'],
      required: true 
    },
    mediaUrl: { type: String },
    mediaPublicId: { type: String },
    message: { type: String, required: true },
    link: { type: String },
    
    scheduledAt: { type: Date, required: true, index: true },
    scheduledDay: { type: String, required: true },
    timeSlotId: { type: String, required: true },
    
    status: { 
      type: String, 
      enum: ['scheduled', 'processing', 'sent', 'failed', 'cancelled'],
      default: 'scheduled',
      index: true
    },
    sentAt: { type: Date },
    errorMessage: { type: String },
    maytapiMessageId: { type: String },
    
    priority: { type: Number, default: 0 },
    isAutoGenerated: { type: Boolean, default: false },
  },
  { timestamps: true }
);

// Indexes for efficient querying
ScheduledPostSchema.index({ userId: 1, scheduledAt: 1, status: 1 });
ScheduledPostSchema.index({ entityId: 1, contentType: 1 });
ScheduledPostSchema.index({ status: 1, scheduledAt: 1 });

export const ScheduledPost: Model<IScheduledPostDocument> =
  mongoose.models.ScheduledPost || 
  mongoose.model<IScheduledPostDocument>('ScheduledPost', ScheduledPostSchema);
```

### Post History Model (Tracking what was posted)
```typescript
// lib/db/models/PostHistory.ts
import mongoose, { Schema, Document, Model } from 'mongoose';

export interface IPostHistory {
  userId: string;
  entityId: string;
  scheduledPostId: string;
  
  contentType: string;
  mediaUrl?: string;
  message: string;
  
  sentAt: Date;
  maytapiMessageId: string;
  
  // For preventing repetition
  contentHash: string;        // Hash of content to detect duplicates
  
  createdAt: Date;
}

export interface IPostHistoryDocument extends IPostHistory, Document {}

const PostHistorySchema = new Schema<IPostHistoryDocument>(
  {
    userId: { type: String, required: true, index: true },
    entityId: { type: String, required: true, index: true },
    scheduledPostId: { type: String, required: true },
    
    contentType: { type: String, required: true },
    mediaUrl: { type: String },
    message: { type: String, required: true },
    
    sentAt: { type: Date, required: true },
    maytapiMessageId: { type: String, required: true },
    
    contentHash: { type: String, required: true, index: true },
  },
  { timestamps: true }
);

// Index for checking recent posts per entity
PostHistorySchema.index({ entityId: 1, sentAt: -1 });
PostHistorySchema.index({ entityId: 1, contentHash: 1 });

export const PostHistory: Model<IPostHistoryDocument> =
  mongoose.models.PostHistory || 
  mongoose.model<IPostHistoryDocument>('PostHistory', PostHistorySchema);
```

### Schedule Settings Model
```typescript
// lib/db/models/ScheduleSettings.ts
import mongoose, { Schema, Document, Model } from 'mongoose';

export interface ITimeSlot {
  id: string;
  time: string;              // HH:mm format
  isActive: boolean;
  label?: string;            // e.g., "Morning Post"
}

export interface IDaySettings {
  day: string;               // monday, tuesday, etc.
  isActive: boolean;
  timeSlots: ITimeSlot[];
}

export interface IScheduleSettings {
  userId: string;
  
  // WhatsApp Channel Info
  whatsappChannelId: string;
  maytapiProductId: string;
  maytapiPhoneId: string;
  
  // Weekly schedule
  weeklySchedule: IDaySettings[];
  
  // Priority settings
  priorityThresholds: {
    highPriority: number;     // Days until lead plaintiff (e.g., 7)
    mediumPriority: number;   // e.g., 14
    lowPriority: number;      // e.g., 30
  };
  
  // Frequency multipliers based on priority
  frequencyMultipliers: {
    critical: number;         // e.g., 3x posts per day
    high: number;             // e.g., 2x
    medium: number;           // e.g., 1.5x
    low: number;              // e.g., 1x
  };
  
  // Content rotation settings
  contentRotation: {
    imageWeight: number;      // 0-100
    videoWeight: number;
    textWeight: number;
    linkWeight: number;
  };
  
  // Auto-scheduling
  autoScheduleEnabled: boolean;
  autoScheduleDaysBefore: number;  // Generate schedule X days before
  
  timezone: string;
  
  createdAt: Date;
  updatedAt: Date;
}

export interface IScheduleSettingsDocument extends IScheduleSettings, Document {}

const TimeSlotSchema = new Schema({
  id: { type: String, required: true },
  time: { type: String, required: true },
  isActive: { type: Boolean, default: true },
  label: { type: String },
});

const DaySettingsSchema = new Schema({
  day: { type: String, required: true },
  isActive: { type: Boolean, default: true },
  timeSlots: [TimeSlotSchema],
});

const ScheduleSettingsSchema = new Schema<IScheduleSettingsDocument>(
  {
    userId: { type: String, required: true, unique: true },
    
    whatsappChannelId: { type: String, required: true },
    maytapiProductId: { type: String, required: true },
    maytapiPhoneId: { type: String, required: true },
    
    weeklySchedule: [DaySettingsSchema],
    
    priorityThresholds: {
      highPriority: { type: Number, default: 7 },
      mediumPriority: { type: Number, default: 14 },
      lowPriority: { type: Number, default: 30 },
    },
    
    frequencyMultipliers: {
      critical: { type: Number, default: 3 },
      high: { type: Number, default: 2 },
      medium: { type: Number, default: 1.5 },
      low: { type: Number, default: 1 },
    },
    
    contentRotation: {
      imageWeight: { type: Number, default: 40 },
      videoWeight: { type: Number, default: 30 },
      textWeight: { type: Number, default: 20 },
      linkWeight: { type: Number, default: 10 },
    },
    
    autoScheduleEnabled: { type: Boolean, default: true },
    autoScheduleDaysBefore: { type: Number, default: 7 },
    
    timezone: { type: String, default: 'America/New_York' },
  },
  { timestamps: true }
);

export const ScheduleSettings: Model<IScheduleSettingsDocument> =
  mongoose.models.ScheduleSettings || 
  mongoose.model<IScheduleSettingsDocument>('ScheduleSettings', ScheduleSettingsSchema);
```

### Message Template Model
```typescript
// lib/db/models/MessageTemplate.ts
import mongoose, { Schema, Document, Model } from 'mongoose';

export interface IMessageTemplate {
  userId: string;
  name: string;
  contentType: 'image' | 'video' | 'text' | 'link';
  
  // Template with placeholders
  // Placeholders: {{companyName}}, {{tickerSymbol}}, {{leadPlaintiffDate}}, {{caseDate}}
  template: string;
  
  // Call to action
  ctaText?: string;
  ctaUrl?: string;
  
  isDefault: boolean;
  isActive: boolean;
  
  createdAt: Date;
  updatedAt: Date;
}

export interface IMessageTemplateDocument extends IMessageTemplate, Document {}

const MessageTemplateSchema = new Schema<IMessageTemplateDocument>(
  {
    userId: { type: String, required: true, index: true },
    name: { type: String, required: true },
    contentType: { 
      type: String, 
      enum: ['image', 'video', 'text', 'link'],
      required: true 
    },
    template: { type: String, required: true },
    ctaText: { type: String },
    ctaUrl: { type: String },
    isDefault: { type: Boolean, default: false },
    isActive: { type: Boolean, default: true },
  },
  { timestamps: true }
);

MessageTemplateSchema.index({ userId: 1, contentType: 1 });

export const MessageTemplate: Model<IMessageTemplateDocument> =
  mongoose.models.MessageTemplate || 
  mongoose.model<IMessageTemplateDocument>('MessageTemplate', MessageTemplateSchema);
```
